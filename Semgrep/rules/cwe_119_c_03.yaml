rules:
  - id: Improper-Restriction-of-Operations-within-the-Bounds-of-a-Memory-Buffer-03
    severity: WARNING
    message: >-
      The buffer `$BUFF` has index `$SINK_VAR` which is accessing out of range and must be validated before using it as a buffer index or buffer length.
    metadata:
      category: security
      cwe2023-top25: true
      cwe2022-top25: true
      cwe2021-top25: true
      subcategory:
        - vuln
      cwe:
        - "CWE-119: Improper Restriction of Operations within the Bounds of a Memory Buffer"
    languages:
      - c
    mode: taint
    references: https://github.com/ppp-project/ppp/commit/a75fb7b198eed50d769c80c36629f38346882cbf
    pattern-sources:
      - by-side-effect: only
        patterns:
          - pattern: $SOURCE_VAR = ...;
          - pattern-inside: |
              $RETURN_TYPE $FUNC(...)
              {
                ...
                $COUNT = $SOURCE_VAR->$CNT;
                ...
                $BUFF = $SOURCE_VAR->$BUF;
                ...
              }
          - pattern-not-inside: |
              ...
              if ($SOURCE_VAR->$CNT >= sizeof($SOURCE_VAR->$BUF)) {
                ...
              }
          - focus-metavariable: $SOURCE_VAR
    pattern-propagators:
      - patterns:
          - pattern: $SINK_VAR < $VAR
          - focus-metavariable: $SINK_VAR
        from: $VAR
        to: $SINK_VAR
    pattern-sinks:
      - patterns:
          - pattern: $SINK = $FUNC($SINK_BUFF, $BUFF[$SINK_VAR]);
          - focus-metavariable: $SINK_VAR
