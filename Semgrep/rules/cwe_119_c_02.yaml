rules:
  - id: Improper-Restriction-of-Operations-within-the-Bounds-of-a-Memory-Buffer-02
    severity: WARNING
    message: >-
      The `$FUNC` copies `$SINK_VAR - $VAL` size to `$BUFF` buffer without proper check on truncation to keep operation within bounderies of memory buffer.
    metadata:
      category: security
      cwe2023-top25: true
      cwe2022-top25: true
      cwe2021-top25: true
      subcategory:
        - vuln
      cwe:
        - "CWE-119: Improper Restriction of Operations within the Bounds of a Memory Buffer"
    languages:
      - c
    mode: taint
    references: https://github.com/kspalaiologos/bzip3/commit/bb06deb85f1c249838eb938e0dab271d4194f8fa
    pattern-sources:
      - by-side-effect: only
        patterns:
          - pattern: 
              $RETURN_TYPE $FUNC(..., $TYPE
              $SOURCE_VAR, ...)
              {
                ...
              }
          - focus-metavariable: $SOURCE_VAR
    pattern-sinks:
      - patterns:
          - pattern: $FUNC($BUFF, $BUFF + $VAL, $SINK_VAR - $VAL);
          - pattern-not-inside: |
              if ($SINK_VAR - $VAL > $NUM || $SINK_VAR < $VAL)
              {
                ...
              }
              ...
          - pattern-not-inside: |
              if ($SINK_VAR >= $VAL)
              {
                ...
              }
              ...
          - pattern-not-inside: |
              if ($SINK_VAR - $VAL >= $MIN)
              {
                ...
              }
              ...
          - pattern-not-inside: |
              $ASSERT($VAL<=$SINK_VAR);
              ...
          - metavariable-regex:
              metavariable: $FUNC
              regex: (\w+)?_?(?i)memmove\b
          - focus-metavariable: $SINK_VAR
