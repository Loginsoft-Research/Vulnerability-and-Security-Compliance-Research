rules:
  - id: Improper-Restriction-of-Operations-within-the-Bounds-of-a-Memory-Buffer-01
    severity: WARNING
    message: >-
      The array: `$TXT->$SINK_BUFF` is getting `$SINK_VAR - $NUM` as index without proper validation of the bounderies which could lead to invalid memory write.
    metadata:
      category: security
      cwe2023-top25: true
      cwe2022-top25: true
      cwe2021-top25: true
      subcategory:
        - vuln
      cwe:
        - "CWE-119: Improper Restriction of Operations within the Bounds of a Memory Buffer"
    languages:
      - c
    mode: taint
    references: https://github.com/jasper-software/jasper/issues/367
    options:
      taint_unify_mvars: true
    pattern-sources:
      - by-side-effect: true
        patterns:
          - pattern: |
              $RETURN_TYPE $FUNC(..., $TYPE $SOURCE_VAR)
              {
                ...
                $TYPE_TXT *$TXT = ...;
                ...
              }
          - focus-metavariable: $SOURCE_VAR
    pattern-sinks:
      - patterns:
          - pattern: $TXT->$SINK_BUFF[$SINK_VAR - $VAL] = ...;
          - pattern-not-inside: |
              if ($SINK_VAR < $VAL)
              {
                ...
              }
              ...
          - pattern-not-inside: |
              memcpy($TXT->$SINK_BUFF, $VAR, $SINK_VAR -$VAL);
              ...
          - pattern-not-inside: |
              strncpy($TXT->$SINK_BUFF, $VAR, MIN($LEN + 1, $SINK_VAR));
              ...
              if ($LEN >= $SINK_VAR)
              ...
          - focus-metavariable: $SINK_VAR