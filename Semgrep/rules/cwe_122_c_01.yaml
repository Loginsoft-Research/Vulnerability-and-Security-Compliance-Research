rules:
  - id: heap-based-buffer-overflow-01
    severity: WARNING
    message: >-
      The heap:`$VAR` allocated by `$ALLOC` has been overwritten in `$FUNC` function as `$SINK_VAR` which would lead to heap overflow vulnerability.
    metadata:
      category: security
      subcategory:
        - vuln
      cwe:
        - "CWE-122: Heap Based Buffer Overflow"
    references: https://github.com/pjsip/pjproject/commit/bc4812d31a67d5e2f973fbfaf950d6118226cf36
    languages:
      - c
    mode: taint
    pattern-sources:
      - by-side-effect: true
        patterns:
          - pattern: |
              $RETURN_TYPE $FUNC(..., $TYPE $SOURCE_VAR, ...)
              {
                ...
              }
          - focus-metavariable: $SOURCE_VAR
    pattern-sinks:
      - patterns:
          - pattern-either:
            - pattern: $FUNC($SINK_BUFF, $SINK_VAR, &$VAL)
            - pattern: $FUNC($SINK_BUFF, $SINK_VAR, $VAL)
          - pattern-inside: |
              $VAL.$LEN = $SOURCE_LEN - $NUM;
              ...
          - pattern-not-inside: |
              if (<... $SOURCE_LEN < $NUM ...>)
                ...
              ...
          - pattern-not-inside: |
              if (<... $SOURCE_LEN >= $NUM ...>)
                ...
          - focus-metavariable: $SINK_VAR
