rules:
  - id: improper-restriction-of-operations-within-the-bounds-of-a-memory-buffer-06
    severity: WARNING
    message: >-
      The function `snprintf` can return a value greater than the bytes copied, `$SINK_VAR`, that would
      be set to `$VAR`, excluding the NUL terminator. The return value `$LEN` must be
      validated to prevent buffer overflows and assertion error.
    metadata:
      category: security
      cwe2023-top25: true
      cwe2022-top25: true
      cwe2021-top25: true
      subcategory:
        - vuln
      cwe:
        - "CWE-119: Improper Restriction of Operations within the Bounds of a Memory Buffer"
    languages:
      - cpp
    references: https://github.com/facebook/hhvm/commit/dbeb9a56a638e3fdcef8b691c2a2967132dae692
    options:
      taint_unify_mvars: true
    mode: taint
    pattern-sources:
      - patterns:
          - pattern-either:
            - pattern: $LEN = snprintf($BUF, $VAL, ...);
    pattern-sinks:
      - patterns:
          - pattern-either:
              - pattern: $VAR.setSize($SINK_VAR);
          - pattern-not-inside: |
              if ($LEN >= $VAL)
              {
                ...
              }
              ...
          - pattern-not-inside: |
              if (<... $LEN < $VAL ...>)
              {
                ...
              }
          - focus-metavariable: $SINK_VAR
