rules:
  - id: improper-restriction-of-operations-within-the-bounds-of-a-memory-buffer-04
    severity: WARNING
    message: >-
      The `$FUNC` is getting instructions to copy `$SOURCE_VAR * $SIZE` size without checking in the boundaries of `$SOURCE_VAR` which could lead to buffer overwrite.
    metadata:
      category: security
      cwe2023-top25: true
      cwe2022-top25: true
      cwe2021-top25: true
      subcategory:
        - vuln
      cwe:
        - "CWE-119: Improper Restriction of Operations within the Bounds of a Memory Buffer"
    languages:
      - c
    references: https://github.com/kn007/silk-v3-decoder/commit/d216599502662db01c07cc0dfd95ff1f1eaaea02
    mode: taint
    pattern-sources:
      - patterns:
          - pattern: |
              $RETURN_TYPE $FUN(...)
              {
                ...
                $VAR = fopen($SOURCE_VAR, ...);
                ...
              }
          - focus-metavariable: $SOURCE_VAR
    pattern-propagators:
      - patterns:
          - pattern-either:
            - pattern: $VAR = fopen($SOURCE_VAR, ...);
            - pattern: $READ_FUNC(&$VAR, ..., $SOURCE_VAR)
        from: $SOURCE_VAR
        to: $VAR
    pattern-sinks:
      - patterns:
          - pattern-either:
              - pattern: $FUNC(..., $SINK_VAR * $SIZE);
          - focus-metavariable: $SINK_VAR
          - pattern-not-inside: |
              if ($SINK_VAR < 0 || $SINK_VAR > $BUFF_SIZE) {
                ...
              }
              ...
          - metavariable-regex:
              metavariable: $FUNC
              regex: (\w+)?_?(?i)memmove\b
