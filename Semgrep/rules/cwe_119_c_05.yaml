rules:
  - id: improper-restriction-of-operations-within-the-bounds-of-a-memory-buffer-05
    severity: WARNING
    message: >-
      The index `$SINK_VAR - $NUM` can be negative which leads to reading before the buffer `$ARR` starts and must be validated before using it as a buffer index or buffer length.
    metadata:
      category: security
      cwe2023-top25: true
      cwe2022-top25: true
      cwe2021-top25: true
      subcategory:
        - vuln
      cwe:
        - "CWE-119: Improper Restriction of Operations within the Bounds of a Memory Buffer"
    languages:
      - c
    references: https://github.com/php/php-src/commit/523f230c831d7b33353203fa34aee4e92ac12bba
    mode: taint
    pattern-sources:
        - patterns:
          - pattern: --$SOURCE_VAR;
          - focus-metavariable: $SOURCE_VAR
    pattern-sinks:
      - patterns:
          - pattern: $ARR[$SINK_VAR - $NUM]
          - pattern-not-inside: |
              if (<... $SOURCE_VAR >= $NUM ...>)
              {
                ...
              }
          - focus-metavariable: $SINK_VAR
