rules:
  - id: heap-based-buffer-overflow-03
    severity: WARNING
    message: >-
      The heap:`$SINK_BUFF` allocated by `$ALLOC` has been overwritten when value of `$LOWER` is not restricted to be higher than `$UPPER`  which would lead to heap overflow vulnerability.
    metadata:
      category: security
      subcategory:
        - vuln
      cwe:
        - "CWE-122: Heap Based Buffer Overflow"
    references: https://github.com/tensorflow/tensorflow/commit/f851613f8f0fb0c838d160ced13c134f778e3ce7
    languages:
      - cpp
    mode: taint
    options:
      taint_unify_mvars: true
    pattern-sources:
      - by-side-effect: true
        patterns:
          - pattern: |
              $RETURN_TYPE $FUNC(..., $TYPE $SOURCE_VAR, ...)
              {
                ...
                $SINK_BUFF->$LOWER.$ALLOC(...);
                ...
                $SINK_BUFF->$UPPER.$ALLOC(...);
                ...
              }
          - focus-metavariable: $SOURCE_VAR
    pattern-sinks:
      - patterns:
          - pattern: $SINK_BUFF->$LOWER[$I] = std::max(..., $SINK_VAR, ...);
          - pattern-inside: |
              ...
              $SINK_BUFF->$UPPER[$I] = std::min(...);
          - pattern-not-inside: |
              ...
              $SINK_BUFF->$LOWER[$I] = std::min($SINK_BUFF->$LOWER[$I], $SINK_BUFF->$UPPER[$I]);
          - focus-metavariable: $SINK_VAR
