rules:
- id: pathtraversal-path-join
  message: Improper validation in file/directory names might give access to arbitrary files and directories stored on file system. This will lead to path traversal vulnerability.
  languages:
    - go
  severity: WARNING
  metadata:
    category: security
    cwe:
      - "CWE-22: Path Traversal"
  pattern-either:
   - patterns:
      - pattern-inside: linesMatches:[...]
      - pattern: |
            os.$OPERATION(filepath.Join($BASEPATH, $PATH))
      - pattern-not: |
            os.$OPERATION(filepath.Join(..., "..."))
      - metavariable-regex:
            metavariable: $OPERATION
            regex: (Create|CreateTemp|Mkdir|MkdirAll|Readlink|ReadFile|OpenFile|Rename|RemoveAll|WriteFile)
   - patterns:
     - pattern-inside: linesMatches:[...]
     - pattern: filepath.Join($DIR, $FILE)
     - pattern-not: filepath.Abs(...)
     - pattern-not: filepath.IsAbs(...)
     - pattern-not: fmt.Errorf(...)
     - pattern-not: glog.V(4).Infof(...)
     - pattern-not: glog.V(3).Infof(...)
     - pattern-not: glog.V(2).Infof(...)
     - pattern-not: glog.V.Infof(...)
     - pattern-not: os.Lstat(...)
     - pattern-not: persist.NewFileLogger(...)
     - pattern-not: persist.SaveJSON(...)
     - pattern-not: osutil.FileReference(...)
     - pattern-not: filepath.Join(..., "...")
     - pattern-not: filepath.Join(..., "...", ...)
     - pattern-not: filepath.Join(..., "..."+$SUFFIX)
     - pattern-not: filepath.Join(..., $PREFIX+"...")
     - pattern-not: filepath.Join(..., $PREFIX+"..."+$SUFFIX)
     - pattern-not: filepath.Join($FUNC("..."), ...)
     - pattern-not: filepath.Join($DIR, fmt.Sprint(...))
     - pattern-not: filepath.Join($DIR, fmt.Sprintf(...))
     - pattern-not: filepath.Join(...) + "..."
   - patterns:
     - pattern-inside: linesMatches:[...]
     - pattern: |
        os.$OPERATION(...)
     - metavariable-regex:
         metavariable: $OPERATION
         regex: (Create|CreateTemp|Mkdir|MkdirAll|Readlink|ReadFile|OpenFile|Rename|RemoveAll|WriteFile)
