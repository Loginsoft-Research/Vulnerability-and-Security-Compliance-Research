rules:
  - id: buffer-copy-without-checking-size-of-input-03
    severity: WARNING
    message: "The use of $FUN without checking of $SINK_VAR input size would lead buffer overflows."
    languages:
      - c
    cwe:
      - "CWE-120: Buffer Copy without Checking Size of Input ('Classic Buffer Overflow')"
    references:
      - https://github.com/videolan/vlc/commit/2e7c7091a61aa5d07e7997b393d821e91f593c39
      - https://github.com/videolan/vlc/commit/fbe2837bc80f155c001781041a54c58b5524fc14
    options:
      taint_unify_mvars: true
    mode: taint
    pattern-sources:
      - by-side-effect: true
        patterns:
          - pattern: |
              $RETURN_TYPE $FUN(..., $TYPE $SOURCE_VAR, ...)
              {
                ...
              }
          - focus-metavariable: $SOURCE_VAR
    pattern-sinks:
      - patterns:
        - pattern-either:
          - pattern: $FUNC($SINK_VAR, ..., $SIZE - $VAL)
        - pattern-either: 
          - pattern-inside: |
              $SINK_VAR = malloc(<... $SIZE ...>);
              ...
        - pattern-not-inside: |
            if (<... $SIZE < $VAL ...>)
            {
              ...
            }
            ...
        - focus-metavariable: $SINK_VAR
        - metavariable-pattern:
            metavariable: $FUNC
            pattern: memcpy