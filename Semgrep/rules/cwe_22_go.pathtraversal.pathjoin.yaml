rules:
- id: PathTraversal-in-pathjoin
  message: Improper validation in file/directory names might give access to arbitrary files and directories stored on file system. This will lead to path traversal vulnerability.
  languages:
    - go
  severity: WARNING
  metadata:
    category: security
    cwe:
      - "CWE-22: Path Traversal"
  pattern-either:
   - patterns:
      - pattern: |
            os.$OPERATION(filepath.Join($BASEPATH, $PATH))
      - pattern-not: |
            os.$OPERATION(filepath.Join(..., "..."))
      - metavariable-regex:
            metavariable: $OPERATION
            regex: (Create|CreateTemp|Mkdir|MkdirAll|Readlink|ReadFile|OpenFile|Rename|RemoveAll|WriteFile)
   - patterns:
     - pattern: filepath.Join($DIR, $FILE)
     - pattern-not-inside: if (!filepath.IsAbs(...)){...}
     - pattern-not-inside: filepath.Abs(...)
     - pattern-not-inside: filepath.IsAbs(...)
     - pattern-not-inside: fmt.Errorf(...)
     - pattern-not-inside: glog.V(4).Infof(...)
     - pattern-not-inside: glog.V(3).Infof(...)
     - pattern-not-inside: glog.V(2).Infof(...)
     - pattern-not-inside: glog.V.Infof(...)
     - pattern-not-inside: os.Lstat(...)
     - pattern-not-inside: persist.NewFileLogger(...)
     - pattern-not-inside: persist.SaveJSON(...)
     - pattern-not-inside: osutil.FileReference{...}
     - pattern-not-inside: osutil.FileReference(...)
     - metavariable-pattern:
        metavariable: $FILE
        patterns:
         - pattern-not: filepath.Join("...")
         - pattern-not: filepath.Join(..., "...")
         - pattern-not: fmt.Sprintf(...)
         - pattern-not: strings.TrimSuffix(...)
         - pattern-not: strings.TrimPrefix(...)
         - pattern-not: ...+"..."+...
         - pattern-not: ...+"..."
         - pattern-not: \"..."+...
         - pattern-not: os.Getenv(...)
         - pattern-not: strings.Replace(...)
         - pattern-not: $ARRAY[...]
         - pattern-not: $OBJ.name(... )
     - pattern-not: filepath.Join(..., "...")
     - pattern-not: filepath.Join(..., "...", ...)
     - pattern-not: filepath.Join(..., "..."+$SUFFIX)
     - pattern-not: filepath.Join(..., $PREFIX+"...")
     - pattern-not: filepath.Join(..., $PREFIX+"..."+$SUFFIX)
     - pattern-not: filepath.Join(..., $PREFIX+"..."+...)
     - pattern-not: filepath.Join($FUNC("..."), ...)
     - pattern-not: filepath.Join($DIR, "..."+...)
     - pattern-not: filepath.Join($DIR, "..."+$PATH+...)
     - pattern-not: filepath.Join($DIR, fmt.Sprint(...))
     - pattern-not: filepath.Join($DIR, fmt.Sprintf(...))
     - pattern-not: filepath.Join(...) + "..."
     - pattern-not: filepath.Join(..., "..."+...)
     - pattern-not: filepath.Join(..., "..."+...+"..."+...)
   - patterns:
     - pattern: |
        $TARGET := path.Join($DEST,$FILE)
        ...
        $PARENT := path.Dir($TARGET)
        ...
        os.$OPERATION(...)
     - metavariable-regex:
         metavariable: $OPERATION
         regex: (Create|CreateTemp|Mkdir|MkdirAll|Readlink|ReadFile|OpenFile|Rename|RemoveAll|WriteFile)
