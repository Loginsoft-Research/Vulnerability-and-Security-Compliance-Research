rules:
  - id: heap-based-buffer-overflow-02
    severity: WARNING
    message: >-
      The heap:`$VAR` allocated by `$ALLOC` has been overwritten in memcpy function as `$SINK_VAR` which would lead to heap overflow vulnerability.
    metadata:
      category: security
      subcategory:
        - vuln
      cwe:
        - "CWE-122: Heap Based Buffer Overflow"
    references: https://github.com/torvalds/linux/commit/69ae4f6aac1578575126319d3f55550e7e440449
    languages:
      - c
    mode: taint
    pattern-sources:
      - by-side-effect: true
        patterns:
          - pattern: |
              $RETURN_TYPE $FUNC(..., $TYPE $SOURCE_VAR, ...)
              {
                ...
              }
          - focus-metavariable: $SOURCE_VAR
    pattern-sinks:
      - patterns:
        - pattern-either: 
          - pattern: memcpy($SINK_BUF + $SIZE, $SINK_VAR, $LEN + $NUM)
        - pattern-not-inside: |
            if ($SUM > $MAX)
            {
              ...
            }
            ...
        - focus-metavariable: $SINK_VAR
