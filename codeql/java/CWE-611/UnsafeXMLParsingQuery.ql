/**
 * @name Unsafe XML Parser Configuration Detection
 * @description Detects XML parsers without proper security configurations through apply method
 * @kind problem
 * @problem.severity error
 * @security-severity 8.0
 * @precision high
 * @tags security
 *       external/cwe/cwe-611
 */

 import java
 import semmle.code.java.security.XmlParsers
 import semmle.code.java.dataflow.DataFlow
 
 class VulnerableXmlParsing extends DocumentBuilderParse {
     VulnerableXmlParsing() {
         exists(Call newDocBuilder |
             newDocBuilder = this.getQualifier() and
             exists(Call factory |
                 factory = newDocBuilder.getQualifier() and
                 factory.getCallee().getDeclaringType() instanceof DocumentBuilderFactory and
                 factory.getQualifier() instanceof TypeAccess and
                 not exists(Call applyMethod |
                     applyMethod = factory and 
                     applyMethod.getCallee().hasName("apply")
                 )
             )
         )
     }
 }
 
 from VulnerableXmlParsing vuln
 select vuln, 
     "XML parser configuration does not use proper security apply method."
